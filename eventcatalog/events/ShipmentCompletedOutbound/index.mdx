---
id: ShipmentCompletedOutbound
name: ShipmentCompletedOutbound
version: '1.0'
summary: Event published by eventbridge service when shipmentcompletedoutbound occurs
owners:
  - eventbridge-service
producers:
  - eventbridge-service
consumers:
  - eventbridge-service
badges:
  - content: "Schema Valid ✓"
    backgroundColor: "#22c55e"
    textColor: white
  - content: "Domain: Distribution"
    backgroundColor: "#3b82f6"
    textColor: white
  - content: "v1.0"
    backgroundColor: "#6366f1"
    textColor: white
---

# ShipmentCompletedOutbound Event

**Schema ID**: 999
**Schema Version**: 1.0
**Subject**: ShipmentCompletedOutboundEvent
**Domain**: Distribution
**Service**: eventbridge-service
**Repository**: biopro-distribution

## Business Context

Event published when shipmentcompletedoutbound occurs in the eventbridge service.

## Event Schema Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `eventId` | `uuid` | Yes | Unique identifier for this event |
| `occurredOn` | `timestamp-millis` | Yes | Timestamp when event occurred |
| `occurredOnTimeZone` | `string` | No | Timezone for occurredOn (default: UTC) |
| `eventType` | `string` | No | Type of event (default: SHIPMENTCOMPLETEDOUTBOUND) |
| `eventVersion` | `string` | No | Version of the event schema (default: 1.0) |
| `payload` | `ShipmentCompletedOutboundPayload` | Yes | Shipment completed event payload |

## Payload Structure

The `ShipmentCompletedOutboundPayload` contains the following fields:

### Shipment Information
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `shipmentNumber` | `long` | Yes | Unique shipment number |
| `orderNumber` | `long` | Yes | Associated order number |
| `completedDate` | `timestamp-millis` | Yes | Date/time when shipment was completed |
| `shipmentStatus` | `string` | Yes | Current status of the shipment |
| `totalItems` | `int` | Yes | Total number of items in shipment |

### Destination Details
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `destinationCode` | `string` | Yes | Destination location code |
| `destinationName` | `string` | No | Destination location name |

### Shipping Details
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `trackingNumber` | `string` | No | Carrier tracking number |
| `carrier` | `string` | No | Shipping carrier name |

### Metadata
| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `completedByEmployeeCode` | `string` | No | Employee code who completed the shipment |
| `transactionId` | `uuid` | Yes | Transaction ID for idempotency |

## Sample Event

### Complete Event Example

```json
{
  "eventId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "occurredOn": 1763355987499,
  "occurredOnTimeZone": "UTC",
  "eventType": "SHIPMENTCOMPLETEDOUTBOUND",
  "eventVersion": "1.0",
  "payload": {
    "shipmentNumber": 789456,
    "orderNumber": 123456,
    "completedDate": 1763355987499,
    "destinationCode": "DEST-001",
    "destinationName": "City Hospital Blood Bank",
    "trackingNumber": "1Z999AA10123456784",
    "carrier": "UPS",
    "totalItems": 5,
    "shipmentStatus": "COMPLETED",
    "completedByEmployeeCode": "EMP-789",
    "transactionId": "xyz789-4567-89ab-cdef-0123456789ab"
  }
}
```

### Payload Only Example

```json
{
  "shipmentNumber": 789456,
  "orderNumber": 123456,
  "completedDate": 1763355987499,
  "destinationCode": "DEST-001",
  "destinationName": "City Hospital Blood Bank",
  "trackingNumber": "1Z999AA10123456784",
  "carrier": "UPS",
  "totalItems": 5,
  "shipmentStatus": "COMPLETED",
  "completedByEmployeeCode": "EMP-789",
  "transactionId": "xyz789-4567-89ab-cdef-0123456789ab"
}
```

## Consumer Implementation with DLQ Support

### Spring Boot Kafka Listener

```java
package com.arcone.biopro.eventbridge.infrastructure.listener;

import com.arcone.biopro.eventbridge.domain.event.ShipmentCompletedOutboundEvent;
import com.arcone.biopro.common.infrastructure.listener.AbstractListener;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.kafka.annotation.KafkaListener;
import org.springframework.kafka.support.KafkaHeaders;
import org.springframework.messaging.handler.annotation.Header;
import org.springframework.messaging.handler.annotation.Payload;
import org.springframework.stereotype.Service;
import reactor.core.publisher.Mono;

@Slf4j
@Service
@RequiredArgsConstructor
public class ShipmentCompletedOutboundEventListener extends AbstractListener<ShipmentCompletedOutboundEvent> {

    private final YourBusinessService businessService;

    @KafkaListener(
        topics = "${kafka.topics.shipmentcompletedoutbound}",
        groupId = "${kafka.consumer.group-id}",
        containerFactory = "kafkaListenerContainerFactory",
        errorHandler = "kafkaListenerErrorHandler"
    )
    public void listen(
            @Payload ShipmentCompletedOutboundEvent event,
            @Header(KafkaHeaders.RECEIVED_TOPIC) String topic,
            @Header(KafkaHeaders.RECEIVED_PARTITION) int partition,
            @Header(KafkaHeaders.OFFSET) long offset
    ) {
        log.info("Received ShipmentCompletedOutboundEvent: eventId={}, topic={}, partition={}, offset={}",
                event.getEventId(), topic, partition, offset);

        processMessage(event)
            .doOnSuccess(result ->
                log.info("Successfully processed ShipmentCompletedOutboundEvent: {}", event.getEventId()))
            .doOnError(error ->
                log.error("Failed to process ShipmentCompletedOutboundEvent: {}", event.getEventId(), error))
            .subscribe();
    }

    @Override
    protected Mono<ShipmentCompletedOutboundEvent> processMessage(ShipmentCompletedOutboundEvent event) {
        return Mono.defer(() -> {
            try {
                validateEvent(event);
                return businessService.handle(event)
                    .doOnError(this::handleBusinessError)
                    .onErrorResume(this::recoverFromError);
            } catch (InvalidEventException e) {
                log.error("Invalid event detected - routing to DLQ: {}", event.getEventId(), e);
                sendToDLQ(event, e);
                return Mono.empty();
            } catch (Exception e) {
                return handleUnexpectedError(event, e);
            }
        });
    }

    private void validateEvent(ShipmentCompletedOutboundEvent event) {
        if (event.getEventId() == null || event.getEventId().isEmpty()) {
            throw new InvalidEventException("Event ID is required");
        }
        // Add domain-specific validations
    }
}
```

## Schema Registry Integration

### Download Schemas

- [Download Complete Event Schema (Avro)](./ShipmentCompletedOutboundEvent.avsc) - Full Avro schema definition including payload
- [Download Payload Schema (Avro)](./ShipmentCompletedOutboundPayload.avsc) - Just the payload schema for reuse
- [Download Payload Example (JSON)](./ShipmentCompletedOutboundPayload.json) - Sample payload in JSON format

### Schema Registry Details

This event uses Avro schema validation through Confluent Schema Registry.

**Subject**: `ShipmentCompletedOutboundEvent`
**Schema ID**: 999
**Current Version**: 1
**Compatibility Mode**: BACKWARD (default)

### Schema Versioning

When updating this schema:

1. **Schema Registry Versioning** - The Schema Registry automatically versions schemas:
   - Each change creates a new version number (v1, v2, v3...)
   - The schema ID remains constant for the subject
   - Consumers can fetch any version using the schema ID + version number

2. **Compatibility Checks** - Before registering a new version:
   ```bash
   # Test compatibility before registering
   curl -X POST http://schema-registry:8081/compatibility/subjects/ShipmentCompletedOutboundEvent/versions/latest \
     -H "Content-Type: application/vnd.schemaregistry.v1+json" \
     -d @ShipmentCompletedOutboundEvent.avsc
   ```

3. **Register New Version** - To register a new schema version:
   ```bash
   # Register new version to Schema Registry
   curl -X POST http://schema-registry:8081/subjects/ShipmentCompletedOutboundEvent/versions \
     -H "Content-Type: application/vnd.schemaregistry.v1+json" \
     -d @ShipmentCompletedOutboundEvent.avsc
   ```

4. **View Version History**:
   ```bash
   # List all versions for this subject
   curl http://schema-registry:8081/subjects/ShipmentCompletedOutboundEvent/versions

   # Get specific version
   curl http://schema-registry:8081/subjects/ShipmentCompletedOutboundEvent/versions/2
   ```

### Schema Evolution Best Practices

- **BACKWARD compatibility** (default): New schema can read data written by previous schema
  - ✅ Add optional fields with defaults
  - ✅ Delete fields
  - ❌ Rename fields
  - ❌ Add required fields

- **FORWARD compatibility**: Previous schema can read data written by new schema
  - ✅ Add fields
  - ✅ Delete optional fields with defaults

- **FULL compatibility**: Both backward and forward compatible
  - ✅ Add optional fields with defaults
  - ✅ Delete optional fields with defaults

## Change Log

### v1.0 (2025-11-16)
- Schema registered with ID 999
- Integrated with Schema Registry
- DLQ error handling configured

<NodeGraph />
